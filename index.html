<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta charset="UTF-8">
  <title>Projeto RA - Marcador Natural</title>
  
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  
  <style>
    body { 
      margin: 0; 
      overflow: hidden; 
      font-family: 'Arial', sans-serif;
    }
    
    #instructions {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      z-index: 9999;
      text-align: center;
      max-width: 80%;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    
    #instructions h3 {
      margin: 0 0 5px 0;
      font-size: 16px;
    }
    
    #instructions p {
      margin: 5px 0;
      font-size: 12px;
      opacity: 0.9;
    }
    
    #status {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(76, 175, 80, 0.9);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      z-index: 9999;
      font-weight: bold;
      display: none;
    }
    
    .detected {
      background: rgba(76, 175, 80, 0.9) !important;
    }
    
    .lost {
      background: rgba(244, 67, 54, 0.9) !important;
    }
  </style>
  
  <script>
    // Componente de interaÃ§Ã£o melhorado
    AFRAME.registerComponent('click-interaction', {
      init: function () {
        const model = this.el;
        const statusDiv = document.getElementById('status');
        let isAnimating = false;
        let clickCount = 0;
        const self = this;
        
        // Aguarda o modelo carregar
        model.addEventListener('model-loaded', () => {
          console.log('Modelo carregado com sucesso!');
          statusDiv.textContent = 'âœ“ Modelo carregado';
          statusDiv.style.display = 'block';
          setTimeout(() => {
            statusDiv.style.display = 'none';
          }, 2000);
          
          // Habilita cursor e raycaster apÃ³s carregar
          model.setAttribute('visible', true);
          self.setupInteraction();
        });
        
        this.setupInteraction = function() {
          // Remove listeners antigos
          model.removeEventListener('click', self.handleClick);
          model.removeEventListener('touchstart', self.handleClick);
          
          // Adiciona novos listeners
          model.addEventListener('click', self.handleClick);
          model.addEventListener('touchstart', self.handleClick);
          
          console.log('InteraÃ§Ã£o configurada!');
        };
        
        this.handleClick = function(evt) {
          evt.stopPropagation();
          evt.preventDefault();
          
          console.log('Clique detectado!');
          clickCount++;
          
          if (!isAnimating) {
            isAnimating = true;
            
            // Efeito visual baseado no nÃºmero de cliques
            const effects = [
              { 
                color: '#ff0000', 
                scale: '0.08 0.08 0.08',
                rotation: '0 360 0',
                message: 'ðŸ”´ Modo Vermelho'
              },
              { 
                color: '#00ff00', 
                scale: '0.04 0.04 0.04',
                rotation: '0 -360 0',
                message: 'ðŸŸ¢ Modo Verde'
              },
              { 
                color: '#0000ff', 
                scale: '0.10 0.10 0.10',
                rotation: '360 0 0',
                message: 'ðŸ”µ Modo Azul'
              },
              { 
                color: '#ffff00', 
                scale: '0.05 0.05 0.05',
                rotation: '0 0 0',
                message: 'ðŸŸ¡ Modo Amarelo'
              }
            ];
            
            const effect = effects[clickCount % effects.length];
            
            console.log('Aplicando efeito:', effect.message);
            
            // Aplica animaÃ§Ã£o de escala
            model.setAttribute('animation__scale', {
              property: 'scale',
              to: effect.scale,
              dur: 600,
              easing: 'easeInOutBack'
            });
            
            // Aplica rotaÃ§Ã£o
            model.setAttribute('animation__rotate', {
              property: 'rotation',
              to: effect.rotation,
              dur: 800,
              easing: 'easeInOutQuad'
            });
            
            // Muda cor emissiva (funciona com luzes)
            const mesh = model.getObject3D('mesh');
            if (mesh) {
              mesh.traverse((node) => {
                if (node.isMesh && node.material) {
                  node.material.emissive = new THREE.Color(effect.color);
                  node.material.emissiveIntensity = 0.8;
                  node.material.needsUpdate = true;
                }
              });
            }
            
            // Feedback visual
            statusDiv.textContent = effect.message;
            statusDiv.style.display = 'block';
            statusDiv.classList.add('detected');
            
            setTimeout(() => {
              isAnimating = false;
              statusDiv.style.display = 'none';
              statusDiv.classList.remove('detected');
            }, 1000);
          }
        };
      }
    });
    
    // Componente para detectar quando o marcador Ã© encontrado/perdido
    AFRAME.registerComponent('target-tracker', {
      init: function() {
        const statusDiv = document.getElementById('status');
        
        this.el.addEventListener('targetFound', () => {
          console.log('Marcador detectado!');
          statusDiv.textContent = 'âœ“ Marcador detectado';
          statusDiv.style.display = 'block';
          statusDiv.classList.add('detected');
          statusDiv.classList.remove('lost');
          
          setTimeout(() => {
            statusDiv.style.display = 'none';
          }, 2000);
        });
        
        this.el.addEventListener('targetLost', () => {
          console.log('Marcador perdido!');
          statusDiv.textContent = 'âœ— Marcador perdido';
          statusDiv.classList.add('lost');
          statusDiv.classList.remove('detected');
          statusDiv.style.display = 'block';
          
          setTimeout(() => {
            statusDiv.style.display = 'none';
          }, 2000);
        });
      }
    });
  </script>
</head>

<body>
  <!-- InstruÃ§Ãµes na tela -->
  <div id="instructions">
    <h3>ðŸ“± Projeto de Realidade Aumentada</h3>
    <p>Aponte a cÃ¢mera para o marcador</p>
    <p>Toque no objeto 3D para mudar cor e tamanho</p>
  </div>
  
  <!-- Status de detecÃ§Ã£o -->
  <div id="status"></div>
  
  <!-- Cena A-Frame com MindAR -->
  <a-scene 
    mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind; filterMinCF: 0.0001; filterBeta: 0.001;" 
    color-space="sRGB" 
    renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true;" 
    vr-mode-ui="enabled: false" 
    device-orientation-permission-ui="enabled: false">
    
    <!-- Assets -->
    <a-assets>
      <a-asset-item 
        id="avatarModel" 
        src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/softmind/scene.gltf">
      </a-asset-item>
    </a-assets>
    
    <!-- CÃ¢mera com cursor para cliques -->
    <a-camera mindar-image-camera="">
      <a-cursor
        fuse="false"
        raycaster="objects: .clickable"
      ></a-cursor>
    </a-camera>
    
    <!-- Entidade com marcador -->
    <a-entity mindar-image-target="targetIndex: 0" target-tracker>
      <!-- Modelo 3D -->
      <a-gltf-model 
        id="model3d"
        src="#avatarModel" 
        position="0 -0.15 0.1"
        rotation="0 0 0"
        scale="0.05 0.05 0.05"
        click-interaction
        animation-mixer="clip: *"
        class="clickable"
      ></a-gltf-model>
      
      <!-- IluminaÃ§Ã£o ambiente forte -->
      <a-light type="ambient" intensity="1.5" color="#ffffff"></a-light>
      <a-light type="directional" intensity="1.0" position="1 1 1" color="#ffffff"></a-light>
      <a-light type="point" intensity="0.8" distance="2" color="#ffffff" position="0 0.3 0.5"></a-light>
    </a-entity>
  </a-scene>
</body>
</html>
